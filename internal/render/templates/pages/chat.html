{{define "chat"}}
{{template "base" .}}
{{end}}

{{define "title"}}Wantok{{end}}

{{define "content"}}
<div class="h-screen flex flex-col" x-data="{ showUserPicker: false, users: [], showSidebar: window.innerWidth >= 768 || !{{.ActiveUserID}} }" @resize.window="showSidebar = window.innerWidth >= 768 || !{{.ActiveUserID}}">
    <!-- Header -->
    <header class="bg-white border-b px-4 py-3 flex justify-between items-center safe-area-inset">
        <div class="flex items-center gap-3">
            {{if .ActiveUserID}}
            <!-- Back button on mobile when in conversation -->
            <a href="/" class="md:hidden p-2 -ml-2 text-gray-600 hover:text-gray-800 touch-target" aria-label="Back to conversations">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            {{end}}
            <h1 class="text-xl font-bold text-gray-800">Wantok</h1>
        </div>
        <div class="flex items-center gap-2 sm:gap-4">
            <span class="text-gray-600 text-sm sm:text-base truncate max-w-[100px] sm:max-w-none">{{.CurrentUserName}}</span>
            {{if .IsAdmin}}
            <a href="/admin" class="text-emerald-600 hover:text-emerald-700 text-sm sm:text-base">Admin</a>
            {{end}}
            <form action="/auth/logout" method="POST" class="inline">
                <button type="submit" class="text-gray-500 hover:text-gray-700 text-sm sm:text-base p-1">Logout</button>
            </form>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- Sidebar - hidden on mobile when viewing conversation -->
        <aside class="w-full md:w-80 bg-gray-50 border-r flex flex-col" :class="{ 'hidden': !showSidebar, 'md:flex': true }">
            <!-- New Conversation Button -->
            <div class="p-4 border-b">
                <button
                    @click="showUserPicker = true; fetch('/users').then(r => r.json()).then(data => users = data)"
                    class="w-full py-3 px-4 bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white rounded-md text-base touch-target"
                >
                    New Conversation
                </button>
            </div>

            <!-- Conversation List -->
            <div class="flex-1 overflow-y-auto">
                {{if .Conversations}}
                {{range .Conversations}}
                <a
                    href="/?user={{.UserID}}"
                    class="block p-4 border-b hover:bg-gray-100 active:bg-gray-200 {{if eq .UserID $.ActiveUserID}}bg-emerald-50{{end}} touch-target"
                >
                    <div class="font-medium text-gray-800">{{.DisplayName}}</div>
                    <div class="text-sm text-gray-500 truncate">{{.LastMessage}}</div>
                </a>
                {{end}}
                {{else}}
                <p class="p-4 text-gray-500 text-sm">No conversations yet</p>
                {{end}}
            </div>
        </aside>

        <!-- Main Chat Area - shown on mobile when viewing conversation -->
        <main class="flex-1 flex flex-col bg-white" :class="{ 'hidden md:flex': !{{.ActiveUserID}} && showSidebar }">
            {{if .ActiveUserID}}
            <!-- Conversation Header -->
            <div class="border-b px-4 py-3">
                <h2 class="font-semibold text-gray-800">{{.ActiveUserName}}</h2>
            </div>

            <!-- Messages -->
            <div id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col-reverse gap-2">
                {{range .Messages}}
                <div class="flex {{if .IsSent}}justify-end{{else}}justify-start{{end}}" data-message-id="{{.ID}}">
                    <div class="max-w-[85%] sm:max-w-xs lg:max-w-md px-4 py-2 rounded-lg {{if .IsSent}}bg-emerald-600 text-white{{else}}bg-gray-200 text-gray-800{{end}}">
                        <p class="break-words">{{.Content}}</p>
                        <p class="text-xs mt-1 {{if .IsSent}}text-emerald-100{{else}}text-gray-500{{end}}">{{.CreatedAt}}</p>
                    </div>
                </div>
                {{end}}
            </div>

            <!-- Message Input -->
            <form
                action="/conversations/{{.ActiveUserID}}/messages"
                method="POST"
                hx-post="/conversations/{{.ActiveUserID}}/messages"
                hx-target="#messages"
                hx-swap="afterbegin"
                hx-on::after-request="this.reset()"
                class="border-t p-3 sm:p-4 flex gap-2 safe-area-inset-bottom"
            >
                <input
                    type="text"
                    name="content"
                    placeholder="Type a message..."
                    class="flex-1 px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-base"
                    autocomplete="off"
                    required
                >
                <button
                    type="submit"
                    class="px-4 sm:px-6 py-3 bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white rounded-md text-base touch-target"
                >
                    Send
                </button>
            </form>
            {{else}}
            <!-- No Conversation Selected - only shown on desktop -->
            <div class="hidden md:flex flex-1 items-center justify-center text-gray-500">
                <p>Select a conversation or start a new one</p>
            </div>
            {{end}}
        </main>
    </div>

    <!-- User Picker Modal -->
    <div
        x-show="showUserPicker"
        x-cloak
        class="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50"
        @click.self="showUserPicker = false"
    >
        <div class="bg-white rounded-t-2xl sm:rounded-lg shadow-lg p-6 w-full sm:max-w-md max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Start New Conversation</h3>
                <button @click="showUserPicker = false" class="text-gray-500 hover:text-gray-700 p-2 -mr-2 touch-target text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto -mx-2">
                <template x-if="users.length === 0">
                    <p class="text-gray-500 text-center py-4">No other users available</p>
                </template>
                <template x-for="user in users" :key="user.id">
                    <a
                        :href="'/?user=' + user.id"
                        class="block p-4 hover:bg-gray-100 active:bg-gray-200 rounded-md touch-target"
                    >
                        <span x-text="user.display_name" class="font-medium"></span>
                        <span x-text="'@' + user.username" class="text-gray-500 text-sm ml-2"></span>
                    </a>
                </template>
            </div>
        </div>
    </div>
</div>

<style>
    [x-cloak] { display: none !important; }

    /* Ensure touch targets are at least 44px for accessibility */
    .touch-target {
        min-height: 44px;
    }

    /* Safe area insets for iOS notch/home indicator */
    .safe-area-inset {
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
    }
    .safe-area-inset-bottom {
        padding-bottom: max(env(safe-area-inset-bottom), 0.75rem);
    }

    /* Prevent text selection on touch */
    @media (hover: none) {
        button, a {
            -webkit-tap-highlight-color: transparent;
        }
    }

    /* Smooth scrolling for messages */
    #messages {
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }
</style>

<script>
// WebSocket connection for real-time messaging
(function() {
    const currentUserID = {{.CurrentUserID}};
    const activeUserID = {{.ActiveUserID}};
    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function messageExists(id) {
        return document.querySelector('[data-message-id="' + id + '"]') !== null;
    }

    function createMessageElement(msg) {
        const isSent = msg.is_sent;
        const justifyClass = isSent ? 'justify-end' : 'justify-start';
        const bgClass = isSent ? 'bg-emerald-600 text-white' : 'bg-gray-200 text-gray-800';
        const timeClass = isSent ? 'text-emerald-100' : 'text-gray-500';

        const div = document.createElement('div');
        div.className = 'flex ' + justifyClass;
        div.setAttribute('data-message-id', msg.id);
        div.innerHTML = `
            <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${bgClass}">
                <p>${escapeHtml(msg.content)}</p>
                <p class="text-xs mt-1 ${timeClass}">${escapeHtml(msg.created_at)}</p>
            </div>
        `;
        return div;
    }

    function handleMessage(data) {
        if (data.type !== 'message') return;

        const msg = data.payload;

        // Skip if message already exists in DOM (prevents duplicates from HTMX + WebSocket)
        if (messageExists(msg.id)) {
            return;
        }

        const messagesContainer = document.getElementById('messages');

        // Determine if this message belongs to the active conversation
        const isFromActiveConversation = (
            (msg.sender_id === activeUserID) ||
            (msg.sender_id === currentUserID && activeUserID > 0)
        );

        // Append message if in the correct conversation
        if (messagesContainer && isFromActiveConversation) {
            // For received messages, check it's from the active user
            // For sent messages (from other devices), we should show them
            if (msg.sender_id === activeUserID || msg.is_sent) {
                const element = createMessageElement(msg);
                // Messages container uses flex-col-reverse, so prepend to show at bottom
                messagesContainer.insertBefore(element, messagesContainer.firstChild);
            }
        }

        // Refresh the page to update conversation list for simplicity
        // A more sophisticated approach would update the sidebar via DOM manipulation
        if (!isFromActiveConversation && msg.sender_id !== currentUserID) {
            // New message from someone not in active conversation - reload to update sidebar
            window.location.reload();
        }
    }

    function connect() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(protocol + '//' + window.location.host + '/ws');

        ws.onopen = function() {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
        };

        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                handleMessage(data);
            } catch (e) {
                console.error('Failed to parse WebSocket message:', e);
            }
        };

        ws.onclose = function() {
            console.log('WebSocket disconnected');
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                console.log('Reconnecting in', delay, 'ms...');
                setTimeout(connect, delay);
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    }

    connect();
})();
</script>
{{end}}
